name: "CodeQL"

on:
  push:
    branches: [ "main", "7.17" ]
  pull_request:
    branches: [ "main" ]
    paths-ignore:
      - '**/*.json'
      - '**/*.md'
      - '**/*.png'
      # - '**/*.yml'
      - '**/*.asciidoc'
      - '**/*.test.*'
      - packages/kbn-ambient-common-types
      - packages/kbn-ambient-ftr-types
      - packages/kbn-ambient-storybook-types
      - packages/kbn-ambient-ui-types
      - packages/kbn-apm-synthtrace
      - packages/kbn-axe-config
      - packages/kbn-babel-plugin-package-imports
      - packages/kbn-babel-preset
      - packages/kbn-babel-register
      - packages/kbn-babel-transform
      - packages/kbn-bazel-packages
      - packages/kbn-bazel-runner
      - packages/kbn-ci-stats-core
      - packages/kbn-ci-stats-performance-metrics
      - packages/kbn-ci-stats-reporter
      - packages/kbn-cli-dev-mode
      - packages/core/test-helpers/core-test-helpers-kbn-server
      - packages/kbn-cypress-config
      - packages/kbn-dev-cli-errors
      - packages/kbn-dev-cli-runner
      - packages/kbn-dev-proc-runner
      - packages/kbn-dev-utils
      - packages/kbn-docs-utils
      - packages/kbn-es
      - packages/kbn-es-archiver
      - packages/kbn-eslint-config
      - packages/kbn-eslint-plugin-disable
      - packages/kbn-eslint-plugin-eslint
      - packages/kbn-eslint-plugin-imports
      - packages/kbn-expect
      - packages/kbn-failed-test-reporter-cli
      - packages/kbn-find-used-node-modules
      - packages/kbn-ftr-common-functional-services
      - packages/kbn-ftr-screenshot-filename
      - packages/kbn-generate
      - packages/kbn-get-repo-files
      - packages/kbn-import-resolver
      - packages/kbn-jest-serializers
      - packages/kbn-journeys
      - packages/kbn-kibana-manifest-schema
      - packages/kbn-managed-vscode-config
      - packages/kbn-managed-vscode-config-cli
      - packages/kbn-optimizer
      - packages/kbn-optimizer-webpack-helpers
      - packages/kbn-package-map
      - packages/kbn-peggy
      - packages/kbn-peggy-loader
      - packages/kbn-performance-testing-dataset-extractor
      - packages/kbn-plugin-generator
      - packages/kbn-plugin-helpers
      - packages/kbn-repo-path
      - packages/kbn-repo-source-classifier
      - packages/kbn-repo-source-classifier-cli
      - packages/kbn-some-dev-log
      - packages/kbn-sort-package-json
      - packages/kbn-spec-to-console
      - packages/kbn-stdio-dev-helpers
      - packages/kbn-storybook
      - packages/kbn-telemetry-tools
      - packages/kbn-test
      - packages/kbn-test-jest-helpers
      - packages/kbn-test-subj-selector
      - packages/kbn-tooling-log
      - packages/kbn-ts-project-linter
      - packages/kbn-ts-project-linter-cli
      - packages/kbn-ts-projects
      - packages/kbn-ts-type-check-cli
      - packages/kbn-web-worker-stub
      - packages/kbn-yarn-lock-validator
      - test
      - x-pack/test
  schedule:
    - cron: '27 21 * * 0'

jobs:
  analyze:
    name: Analyze
    runs-on: ubuntu-latest
    permissions:
      actions: read
      contents: read
      security-events: write

    strategy:
      fail-fast: false
      matrix:
        language: [ 'javascript' ]

    steps:
    - name: Checkout repository
      uses: actions/checkout@v3

    - name: Initialize CodeQL
      uses: github/codeql-action/init@v2
      with:
        languages: ${{ matrix.language }}
        config-file: ./.github/codeql/codeql-config.yml

    - name: Autobuild
      uses: github/codeql-action/autobuild@v2

    # - name: Bootstrap
    #   run: yarn kbn bootstrap

    - name: Perform CodeQL Analysis
      uses: github/codeql-action/analyze@v2
      with:
        category: "/language:${{matrix.language}}"
